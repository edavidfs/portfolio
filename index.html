<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-gray-800 text-white p-4">
    <h1 class="text-xl font-semibold">Portfolio</h1>
  </nav>

  <div class="flex">
    <!-- Sidebar -->
    <aside id="sidebar" class="relative w-64 bg-white border-r min-h-screen p-4 space-y-2">
      <div class="flex items-center justify-between mb-3">
        <button id="btn-toggle-sidebar" title="Contraer/expandir" class="p-2 rounded hover:bg-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M7.293 14.707a1 1 0 010-1.414L9.586 11 7.293 8.707a1 1 0 111.414-1.414l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414 0z"/>
          </svg>
        </button>
      </div>

      <button id="btn-positions" class="nav-btn w-full flex items-center gap-2 text-left px-3 py-2 rounded hover:bg-gray-100 font-medium text-gray-700">
        <span class="icon w-5 h-5" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h14v2H3V3zm0 4h10v2H3V7zm0 4h14v2H3v-2zm0 4h10v2H3v-2z"/></svg>
        </span>
        <span class="label">Posiciones</span>
      </button>
      <button id="btn-cash" class="nav-btn w-full flex items-center gap-2 text-left px-3 py-2 rounded hover:bg-gray-100 font-medium text-gray-700">
        <span class="icon w-5 h-5" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M4 5a2 2 0 00-2 2v6a2 2 0 002 2h12V5H4zm12 8H4V7h12v6zm-6-1a2 2 0 100-4 2 2 0 000 4z"/></svg>
        </span>
        <span class="label">Efectivo</span>
      </button>
      <button id="btn-transfers" class="nav-btn w-full flex items-center gap-2 text-left px-3 py-2 rounded hover:bg-gray-100 font-medium text-gray-700">
        <span class="icon w-5 h-5" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 10h9l-3-3 1.414-1.414L15.828 11l-5.414 5.414L9 15l3-3H3v-2z"/></svg>
        </span>
        <span class="label">Transferencias</span>
      </button>
      <button id="btn-dividends" class="nav-btn w-full flex items-center gap-2 text-left px-3 py-2 rounded hover:bg-gray-100 font-medium text-gray-700">
        <span class="icon w-5 h-5" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 01-1-1v-1.382a3 3 0 010-5.236V8a1 1 0 112 0v1.382a3 3 0 010 5.236V16a1 1 0 01-1 1zM5 3a2 2 0 00-2 2v10a2 2 0 002 2h10V3H5z"/></svg>
        </span>
        <span class="label">Dividendos</span>
      </button>
      <div class="pt-4 border-t"></div>
      <button id="btn-imports" class="nav-btn w-full flex items-center gap-2 text-left px-3 py-2 rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100 font-medium">
        <span class="icon w-5 h-5" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3h14v2H3V3zm5 4h4v4h3l-5 5-5-5h3V7z"/></svg>
        </span>
        <span class="label">Importaciones</span>
      </button>

      <!-- Resizer -->
      <div id="sidebar-resizer" class="absolute top-0 right-0 h-full w-1 cursor-col-resize"></div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 p-6 space-y-8">
      <!-- Posiciones View -->
      <section id="view-positions" class="space-y-6">
        <div class="container mx-auto">
          <canvas id="positionsChart" height="120"></canvas>
        </div>
        <div class="container mx-auto">
          <table class="min-w-full divide-y divide-gray-200" id="positionsTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="ticker">Ticker<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="quantity">Posición<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="purchase">Precio Compra<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="baseCostPerShare">Base coste/acc<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="baseCostTotal">Coste total<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="div12mPerShare">Div 12m/acc<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="totalDividends">Div totales<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="weightPct">% Portafolio<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="current">Precio Actual<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="currentValue">Valor total<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="unrealizedPct">% Beneficio no realizado<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="realizedProfit">Beneficio realizado<span class="opacity-50">⇅</span></button></th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider"><button type="button" class="sort-btn flex items-center gap-1" data-sort="dividendYieldPct">% Rentab. Div (coste)<span class="opacity-50">⇅</span></button></th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Efectivo View -->
      <section id="view-cash" class="hidden space-y-6">
        <div class="container mx-auto">
          <canvas id="cashChart" height="140"></canvas>
        </div>
        <div class="container mx-auto">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Operaciones de efectivo (Transferencias y FX)</h3>
          <table class="min-w-full divide-y divide-gray-200" id="cashOpsTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importe</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moneda</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Transferencias View -->
      <section id="view-transfers" class="hidden">
        <table class="min-w-full divide-y divide-gray-200" id="transfersTable">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importe</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moneda</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </section>

      <!-- Dividendos View -->
      <section id="view-dividends" class="hidden space-y-6">
        <table class="min-w-full divide-y divide-gray-200" id="dividendsTable">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importe</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moneda</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticker</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impuesto</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">País</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200"></tbody>
        </table>
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Totales por día</h3>
          <table class="min-w-full divide-y divide-gray-200" id="dividendsDailyTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importe</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moneda</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Totales por activo</h3>
          <table class="min-w-full divide-y divide-gray-200" id="dividendsAssetTable">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticker</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Importe</th>
                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moneda</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Importaciones View -->
      <section id="view-imports" class="hidden space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="transfersInput">Importar transferencias</label>
          <input type="file" id="transfersInput" accept=".csv" multiple class="block w-full text-sm text-gray-700" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="tradesInput">Importar compra/venta de acciones</label>
          <input type="file" id="tradesInput" accept=".csv" class="block w-full text-sm text-gray-700" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="dividendsInput">Importar dividendos</label>
          <input type="file" id="dividendsInput" accept=".csv" multiple class="block w-full text-sm text-gray-700" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1" for="optionsInput">Importar opciones</label>
          <input type="file" id="optionsInput" accept=".csv" class="block w-full text-sm text-gray-700" />
        </div>
        <div class="flex items-center gap-3">
          <button id="importSelectedBtn" class="inline-flex items-center px-3 py-2 border border-green-300 text-sm font-medium rounded-md text-green-700 bg-white hover:bg-green-50">
            Importar seleccionados
          </button>
          <button id="resetBtn" class="inline-flex items-center px-3 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
            Reset (borrar datos locales)
          </button>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script src="persistence.js"></script>
  <script src="logic.js"></script>
  <!-- Toasts -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite" aria-atomic="true"></div>
</body>

</html>
